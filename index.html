<!DOCTYPE html>
<html>
<head>
	<title>Xedule 2.0</title>
	<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <header>
        <div style="display:inline-block;vertical-align:middle;height:40px;"></div>
        <a id="navicon-header" class="ion-navicon-round" style="position:absolute; top:3px;color: #FFF;font-size: 18pt;cursor:pointer;"> Xedule 2.0</a>
    </header>

    <div class="sidebar">
        <div class="header">
            <a id="close-sidebar" class="ion-close-round" style="color: #FFF;font-size: 10pt;padding-left: 320px;cursor:pointer;"></a>
            <span class="title"><i class="ion-gear-a"></i> Settings</span>
        </div>
        <div class="content">
            Klas:
            <select id="classNr" class="form-control">
		<!-- Attendees for location ID 34, last updated 2015-03-09 -->
		<option value="18954">B-ASIP</option>
		<option disabled>--B-BS2---</option>
		<option value="14249">B-BS2-1a</option>
		<option value="15535">B-BS2-1b</option>
		<option value="14264">B-BS2-2a</option>
		<option value="14265">B-BS2-2b</option>
		<option disabled>--B-BSs2--</option>
		<option value="21744">B-BSs2-1a</option>
		<option disabled>--B-Com3--</option>
		<option value="14300">B-Com3-1a</option>
		<option value="18101">B-Com3-1b</option>
		<option value="14353">B-Com3-2a</option>
		<option disabled>--B-DH2---</option>
		<option value="14392">B-DH2-1a</option>
		<option value="14397">B-DH2-1b</option>
		<option value="14398">B-DH2-1c</option>
		<option value="14399">B-DH2-2a</option>
		<option value="14401">B-DH2-2b</option>
		<option value="19244">B-DH2-extraneus</option>
		<option disabled>--B-DH3---</option>
		<option value="14402">B-DH3-1a</option>
		<option value="14279">B-DH3-1b</option>
		<option value="14324">B-DH3-1c</option>
		<option value="21743">B-DH3-1d</option>
		<option value="14410">B-DH3-2a</option>
		<option value="14411">B-DH3-2b</option>
		<option disabled>--B-DH4---</option>
		<option value="14412">B-DH4-1a</option>
		<option value="14277">B-DH4-1b</option>
		<option disabled>--B-DHb2--</option>
		<option value="14480">B-DHb2-1</option>
		<option disabled>--B-DHb3--</option>
		<option value="14481">B-DHb3-1</option>
		<option value="14483">B-DHb3-2</option>
		<option value="14482">B-DHb3-ah</option>
		<option value="18651">B-DHb3-jumbo</option>
		<option value="14355">B-DHb3-tc</option>
		<option disabled>--B-DHb4--</option>
		<option value="14372">B-DHb4-1</option>
		<option disabled>--B-DHB4--</option>
		<option value="19245">B-DHB4-tc</option>
		<option disabled>--B-EAL1--</option>
		<option value="14369">B-EAL1-1a</option>
		<option disabled>--B-EAV1--</option>
		<option value="14360">B-EAV1-1a</option>
		<option value="14366">B-EAV1-1b</option>
		<option value="18503">B-EAV1-1c</option>
		<option disabled>--B-Fin3--</option>
		<option value="14284">B-Fin3-1a</option>
		<option value="14321">B-Fin3-1b</option>
		<option value="14282">B-Fin3-2a</option>
		<option value="14291">B-Fin3-2b</option>
		<option value="14336">B-Fin34-3a</option>
		<option disabled>--B-GAM4--</option>
		<option value="14375">B-GAM4-1</option>
		<option value="18506">B-GAM4-1AG</option>
		<option value="18510">B-GAM4-1GA</option>
		<option value="18511">B-GAM4-1GD</option>
		<option value="14387">B-GAM4-2</option>
		<option value="18507">B-GAM4-2AG</option>
		<option value="18508">B-GAM4-2GA</option>
		<option value="18512">B-GAM4-2GD</option>
		<option value="14486">B-GAM4-3</option>
		<option value="21749">B-GAM4-3AG</option>
		<option value="21751">B-GAM4-3GA</option>
		<option value="21753">B-GAM4-3GD</option>
		<option value="14390">B-GAM4-4</option>
		<option value="18509">B-GAM4-4AG</option>
		<option value="18505">B-GAM4-4GA</option>
		<option value="18513">B-GAM4-4GD</option>
		<option disabled>--B-ID4---</option>
		<option value="14424">B-ID4-1a</option>
		<option value="14431">B-ID4-1b</option>
		<option value="14435">B-ID4-2</option>
		<option value="19829">B-ID4-3</option>
		<option disabled>--B-ITA4--</option>
		<option value="14490">B-ITA4-2a</option>
		<option value="14293">B-ITA4-3a</option>
		<option disabled>--B-ITB4--</option>
		<option value="14307">B-ITB4-1a</option>
		<option value="14308">B-ITB4-1b</option>
		<option value="14327">B-ITB4-1c</option>
		<option value="14489">B-ITB4-2a</option>
		<option value="14329">B-ITB4-3a</option>
		<option value="14295">B-ITB4-4a</option>
		<option disabled>--B-ITM2--</option>
		<option value="14318">B-ITM2-1a</option>
		<option value="14337">B-ITM2-2a</option>
		<option disabled>--B-ITM3--</option>
		<option value="14302">B-ITM3-1a</option>
		<option value="14488">B-ITM3-2a</option>
		<option disabled>--B-ITN4--</option>
		<option value="14487">B-ITN4-3a</option>
		<option value="14275">B-ITN4-4a</option>
		<option disabled>--B-ITS3--</option>
		<option value="14274">B-ITS3-1a</option>
		<option value="14342">B-ITS3-1b</option>
		<option value="14273">B-ITS3-2a</option>
		<option value="14270">B-ITS3-2b</option>
		<option value="21745">B-ITS3-F15</option>
		<option disabled>--B-JAM4--</option>
		<option value="13452">B-JAM4-1a</option>
		<option value="13456">B-JAM4-1b</option>
		<option value="13459">B-JAM4-2a</option>
		<option value="13460">B-JAM4-2b</option>
		<option disabled>--B-JUR4--</option>
		<option value="14314">B-JUR4-1a</option>
		<option value="14332">B-JUR4-1b</option>
		<option value="14312">B-JUR4-1c</option>
		<option value="14310">B-JUR4-2a</option>
		<option value="14438">B-JUR4-2b</option>
		<option value="19830">B-JUR4-2c</option>
		<option value="15523">B-JUR4-2Z2</option>
		<option value="15528">B-JUR4-2Z1</option>
		<option value="14334">B-JUR4-3a</option>
		<option value="14440">B-JUR4-3b</option>
		<option disabled>--B-JURb--</option>
		<option value="21747">B-JURb4-1a</option>
		<option value="21746">B-JURb4-1b</option>
		<option disabled>--B-LM2---</option>
		<option value="14442">B-LM2-1</option>
		<option value="14443">B-LM2-2</option>
		<option disabled>--B-MMC4--</option>
		<option value="14297">B-MMC4-1a</option>
		<option value="14335">B-MMC4-2a</option>
		<option disabled>--B-MODE--</option>
		<option value="14464">B-MODE4-1a</option>
		<option value="14469">B-MODE4-1b</option>
		<option value="14470">B-MODE4-2a</option>
		<option value="14471">B-MODE4-2b</option>
		<option value="14472">B-MODE4-3</option>
		<option disabled>--B-MV4---</option>
		<option value="14446">B-MV4-1a</option>
		<option value="14455">B-MV4-1b</option>
		<option value="14456">B-MV4-2a</option>
		<option value="14457">B-MV4-2b</option>
		<option value="14491">B-MV4-3a</option>
		<option value="21748">B-MV4-3aud</option>
		<option value="14492">B-MV4-3b</option>
		<option value="21750">B-MV4-3gra</option>
		<option value="14458">B-MV4-4a</option>
		<option value="14460">B-MV4-4art</option>
		<option value="14459">B-MV4-4aud</option>
		<option value="14462">B-MV4-4b</option>
		<option value="14461">B-MV4-4gra</option>
		<option value="15530">B-MV4-4Z1</option>
		<option value="15529">B-MV4-4Z2</option>
		<option value="15531">B-MV4-4Z3</option>
		<option disabled>--B-SE3---</option>
		<option value="14315">B-SE3-1</option>
		<option value="14317">B-SE3-2</option>
		<option disabled>--B-SE4---</option>
		<option value="14299">B-SE4-3</option>
		<option disabled>--B-SEb3--</option>
		<option value="14478">B-SEb3-13</option>
		<option value="14477">B-SEb3-14</option>
		<option disabled>--B-TOE2--</option>
		<option value="14254">B-TOE2-1a</option>
		<option value="14255">B-TOE2-1b</option>
		<option value="14256">B-TOE2-1c</option>
		<option value="14484">B-TOE2-2a</option>
		<option value="14485">B-TOE2-2b</option>
		<option disabled>--RTOM-B--</option>
		<option value="24229">RTOM-B1CL</option>
		<option value="24230">RTOM-B2CL</option>
		    </select>
            Week nummer:
            <select id="week" class="form-control">
                <!--<option value="1">2015/1</option>
                <option value="2">2015/2</option>
                <option value="3">2015/3</option>
                <option value="4">2015/4</option>
                <option value="5" selected>2015/5</option>
                <option value="6">2015/6</option>
		<option value="7">2015/7</option>-->
            </select>
            <!--<br>
	    <input type="checkbox" name="remember" value="1" checked> Instellingen onthouden
	    <br>-->
            <br>
            <button id="send-setting" class="btn btn-success">Save</button>
        </div>
    </div>


    <div style="height:60px;"></div>
	<div class="container">
	<table class="rooster-table table table-bordered">
		<thead>
			<tr>
				<td></td>
				<td style="width: 101px;"></td>
				<td style="width: 167px;">maandag</td>
				<td style="width: 167px;">dinsdag</td>
				<td style="width: 167px;">woensdag</td>
				<td style="width: 167px;">donderdag</td>
				<td style="width: 167px;">vrijdag</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>1</td>
				<td>08:30-09:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>2</td>
				<td>09:00-09:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>3</td>
				<td>09:30-10:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>4</td>
				<td>10:00-10:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>5</td>
				<td>10:30-11:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>6</td>
				<td>11:00-11:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>7</td>
				<td>11:30-12:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>8</td>
				<td>12:00-12:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>9</td>
				<td>12:30-13:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>10</td>
				<td>13:00-13:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>11</td>
				<td>13:30-14:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>12</td>
				<td>14:00-14:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>13</td>
				<td>14:30-15:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>14</td>
				<td>15:00-15:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>15</td>
				<td>15:30-16:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>16</td>
				<td>16:00-16:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>17</td>
				<td>16:30-17:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>18</td>
				<td>17:00-17:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>19</td>
				<td>17:30-18:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			
		</tbody>
	</table>
	<!-- <div class="lesson" style="left: 150px; top: 51px;">
		<span class="lesson-name">rek</span><br>
		<span class="teacher">HOD</span>
	</div> -->
	</div>

	<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="jquery-cookie.js"></script>
	<script type="text/javascript">
		
		var weekDays = ["zondag", "maandag", "dinsdag", "woensdag", "donderdag", "vrijdag", "zaterdag"];
		var months = ["jan", "feb", "maa", "apr", "mei", "jun", "jul", "aug", "sep", "okt", "nov", "dec"];

		// Credit: http://stackoverflow.com/questions/7765767/show-week-number-with-javascript
		// (With changes)
		Date.prototype.getWeek = function() {
			var onejan = new Date(this.getFullYear(),0,1);
			var today = new Date(this.getFullYear(),this.getMonth(),this.getDate());
			var dayOfYear = ((today - onejan + 86400000)/86400000);
			return Math.ceil(dayOfYear/7)
		}
		
		/*
		   Output of below for-loop
		   (d.getWeek, d.getDay)
		   6 0
		   6 1
		   6 2
		   6 3
		   7 4
		   7 5
		   7 6
		   7 0
		   7 1
		   7 2
		*/
		/*for(var i = 0; i < 10; i++) {
			var d = new Date();
			d.setTime(d.getTime()+(86400*i*1000));
			console.log(d.getWeek(), d.getDay());
		}*/

		var d = new Date();
		var currentWeek = d.getWeek();
		var currentYear = d.getFullYear();


		// Show the next week if we're in the weekend. (6 -> Saturday. 0 -> Sunday)
		/*if(d.getDay() == 6 || d.getDay() == 0) {
		    console.log("CurrentWeek pre change: ", currentWeek);
		    // Add one week. 
		    // Don't add seven days. See the commented for-loop (and the output) above.
		    d.setDate(d.getDate() + 5); 
		    currentWeek = d.getWeek();
		    console.log("CurrentWeek post change:", currentWeek);
		}*/

		// Let's hope this doesn't break when getDate() + 5 > maximum-date-of-this-month
		d.setDate(d.getDate() + 5);
		console.log("CurrentWeek:\t%d\nOld week:\t%s\nDay of week:\t%d.", d.getWeek(), currentWeek, d.getDay());
		currentWeek = d.getWeek();

		// Fill the week select box.
		// The client only sees it after they click something, so they shouldn't see the value change when loading. 
		var append;

		var tempYr = currentYear;
		var tempI;
		for(var i = currentWeek+1; i > -52; i--) {
			// Because of currentWeek+1;
			/*if(i > 52) {
				break;
			}*/
			if(i < 1 && tempYr == currentYear) {
				tempYr--;
			}
			tempI = (i < 1) ? (i - 52 * -1) : i
			append += "<option value='" + tempYr + ":" + tempI + "'>" + tempYr + " / " + ((tempI < 10) ? "0" : "") + tempI + "</option>";
			if(i == 1) {
				append += "<option disabled>-</option>";
			}
		}
		$('#week').append(append);

		// Week to initially show after load
		var weekToShow = currentWeek;
		var yearToShow = currentYear;
		var hash = window.location.hash.substring(1).split("/"); // Substring removed the hash sign. 
		if(hash.length > 2 && parseInt(hash[1]) != 0) {
			yearToShow = parseInt(hash[1]);
			if(parseInt(hash[2]) != 0){
				weekToShow = parseInt(hash[2]);
			}
		}

		// Set the select element for the weeks to the correct week. 
		$('#week').val(yearToShow + ":" + weekToShow);

		// OnLoad
		if(hash[0] != "") {
			refeshRooster(hash[0], yearToShow, weekToShow);
			$('#classNr').val(hash[0]);
		} else if($.cookie('roosterClassNr')) {
			refeshRooster($.cookie('roosterClassNr'), yearToShow, weekToShow);
		 	$('#classNr').val($.cookie('roosterClassNr'));
		}

		$('#navicon-header').click(function() {
		    $('.sidebar').css('left', '0px');
		});

		$('#close-sidebar').click(function() {
		    $('.sidebar').css('left', '-360px');
		});

		$('#send-setting').click(function() {
		    var classNr = $('#classNr').val();
		    var week = $('#week').val().split(":");
		    $.cookie('roosterClassNr', classNr);
		    if($('.lesson').length != 0) {
			$('.lesson').fadeOut('400');
			setTimeout(function() {
			    $('.lesson').remove();
			    refeshRooster(classNr, week[0], week[1]);
			}, 400);
		    }else{
			refeshRooster(classNr, week[0], week[1]);
		    }
		});

		function refeshRooster(classNr, year, week) {
		    $.get('http://xedule.novaember.com/weekschedule.'+classNr+'.json?year='+year+'&week='+week, function(data){
			var data2 = $.parseJSON(data);
			var a = data2[0];
			var i = 0;
			for (k in data2) {
			    var v = data2[k];
			    var d = new Date(v.date);
			    
			    for (key in v.events) {
				var b = v.events[key];

				if (b == null) continue;

				// Calculate start time to float
				var startSplit = b.start.split(':');
				var startHour = parseFloat(startSplit[0]);
				var startMinute = parseFloat(startSplit[1]/60);
				var start = startHour+startMinute;

				// Calculate end time to float
				var endSplit = b.end.split(':');
				var endHour = parseFloat(endSplit[0]);
				var endMinute = parseFloat(endSplit[1]/60);
				var end = endHour+endMinute;

				var height = (end-start)*100;

				var color;
				var locatie;
				var staff = "";

				if(b.facilities.length == 0) 
				{ color = "#CCCCCC"; locatie=''; }else{ locatie = b.facilities[0]; color = getColor(b.facilities[0]); }

				if(b.staffs.length > 0) {
					staff = b.staffs[0];
				}

				if(b.facilities.length > 0 && b.staffs.length > 0) {
					locatie += " - ";
				}

				var out  = '<div style="border-left-color: '+color+'; height:'+(height-1)+'px; left:'+((k*167)+150)+'px; top:'+(51+(start-8.5)*100)+'px" class="lesson">';
				    out += '<span class="lesson-name">'+b.description+'</span><br>';
				    out += '<span>'+locatie+'</span><span class="teacher">'+staff+'</span>';
				    out += '</div>';

				$('.container').append(out);


				//console.log(b);

				//console.log(start-8.5);
			    }
			    $('table thead tr td:nth-child(' + (3+i) + ')').html(weekDays[d.getDay()] + " " + d.getDate() + " " + months[d.getMonth()]);
			    i++;
			}
			$('table thead tr td:nth-child(2)').html(year + "/" + week);
			$('.lesson').fadeIn('400');
			window.location.hash = classNr + "/" + year + "/" + ((week == currentWeek) ? 0 : week);
			document.title = document.title.split(" - ")[0] + " - " + $("#classNr option[value='" + classNr + "']").text() + " - " + year + "/" + week;
		    });
		};

		function getColor(input)
		{
		    var sum = 0;

		    for(var i = 0; i < input.length; i++)
		    {
			sum += input.charCodeAt(i) * (i + 1);
		    }

		    var hue = (sum * Math.PI * 1000) % 360;

		    return "hsl(" + hue + ", 50%, 50%)";
		};
		
	</script>
</body>
</html>
