<!DOCTYPE html>
<html>
<head>
	<title>Xedule 2.0</title>
	<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
	<link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <header>
        <div style="display:inline-block;vertical-align:middle;height:40px;"></div>
        <span id="navicon-header" class="ion-navicon-round" style="position:absolute; top:3px;color: #FFF;font-size: 18pt;cursor:pointer;"> Xedule 2.0</span>
    </header>

    <div class="sidebar">
        <div class="header">
            <span id="close-sidebar" class="ion-close-round" style="color: #FFF;font-size: 10pt;padding-left: 320px;cursor:pointer;"></span>
            <span class="title"><i class="ion-gear-a"></i> Settings</span>
        </div>
        <div class="content">
            Klas:
            <select id="classNr" class="form-control">
                <option value="14293">B-ITA4-3a</option>
                <option value="14329">B-ITB4-3a</option>
                <option value="14327">B-ITB4-1c</option>
                <option value="9018">RENG4V2B</option>
            </select>
            Week nummer:
            <select id="week" class="form-control">
                <!--<option value="1">2015/1</option>
                <option value="2">2015/2</option>
                <option value="3">2015/3</option>
                <option value="4">2015/4</option>
                <option value="5" selected>2015/5</option>
                <option value="6">2015/6</option>
		<option value="7">2015/7</option>-->
            </select>
            <!--<br>
	    <input type="checkbox" name="remember" value="1" checked> Instellingen onthouden
	    <br>-->
            <br>
            <button id="send-setting" class="btn btn-success">Save</button>
        </div>
    </div>


    <div style="height:60px;"></div>
	<div class="container">
	<table class="rooster-table table table-bordered">
		<thead>
			<tr>
				<td></td>
				<td style="width: 101px;"></td>
				<td style="width: 167px;">maandag</td>
				<td style="width: 167px;">dinsdag</td>
				<td style="width: 167px;">woensdag</td>
				<td style="width: 167px;">donderdag</td>
				<td style="width: 167px;">vrijdag</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>1</td>
				<td>08:30-09:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>2</td>
				<td>09:00-09:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>3</td>
				<td>09:30-10:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>4</td>
				<td>10:00-10:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>5</td>
				<td>10:30-11:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>6</td>
				<td>11:00-11:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>7</td>
				<td>11:30-12:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>8</td>
				<td>12:00-12:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>9</td>
				<td>12:30-13:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>10</td>
				<td>13:00-13:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>11</td>
				<td>13:30-14:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>12</td>
				<td>14:00-14:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>13</td>
				<td>14:30-15:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>14</td>
				<td>15:00-15:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>15</td>
				<td>15:30-16:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>16</td>
				<td>16:00-16:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>17</td>
				<td>16:30-17:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>18</td>
				<td>17:00-17:30</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			<tr>
				<td>19</td>
				<td>17:30-18:00</td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
				<td></td>
			</tr>
			
		</tbody>
	</table>
	<!-- <div class="lesson" style="left: 150px; top: 51px;">
		<span class="lesson-name">rek</span><br>
		<span class="teacher">HOD</span>
	</div> -->
	</div>

	<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
	<script type="text/javascript" src="jquery-cookie.js"></script>
	<script type="text/javascript">
		
		var weekDays = ["zondag", "maandag", "dinsdag", "woensdag", "donderdag", "vrijdag", "zaterdag"];
		var months = ["jan", "feb", "maa", "apr", "mei", "jun", "jul", "aug", "sep", "okt", "nov", "dec"];

		// Credit: http://stackoverflow.com/questions/7765767/show-week-number-with-javascript
		// (With changes)
		Date.prototype.getWeek = function() {
			var onejan = new Date(this.getFullYear(),0,1);
			var today = new Date(this.getFullYear(),this.getMonth(),this.getDate());
			var dayOfYear = ((today - onejan + 86400000)/86400000);
			return Math.ceil(dayOfYear/7)
		}
		
		/*
		   Output of below for-loop
		   (d.getWeek, d.getDay)
		   6 0
		   6 1
		   6 2
		   6 3
		   7 4
		   7 5
		   7 6
		   7 0
		   7 1
		   7 2
		*/
		/*for(var i = 0; i < 10; i++) {
			var d = new Date();
			d.setTime(d.getTime()+(86400*i*1000));
			console.log(d.getWeek(), d.getDay());
		}*/

		var d = new Date();
		var currentWeek = d.getWeek();
		var currentYear = d.getFullYear();


		// Show the next week if we're in the weekend. (6 -> Saturday. 0 -> Sunday)
		/*if(d.getDay() == 6 || d.getDay() == 0) {
		    console.log("CurrentWeek pre change: ", currentWeek);
		    // Add one week. 
		    // Don't add seven days. See the commented for-loop (and the output) above.
		    d.setDate(d.getDate() + 5); 
		    currentWeek = d.getWeek();
		    console.log("CurrentWeek post change:", currentWeek);
		}*/

		// Let's hope this doesn't break when getDate() + 5 > maximum-date-of-this-month
		d.setDate(d.getDate() + 5);
		console.log("CurrentWeek:\t%d\nOld week:\t%s\nDay of week:\t%d.", d.getWeek(), currentWeek, d.getDay());
		currentWeek = d.getWeek();

		// Fill the week select box.
		// The client only sees it after they click something, so they shouldn't see the value change when loading. 
		var append;
		for(var i = 1; i <= currentWeek+1; i++) {
			// Because of currentWeek+1;
			if(i > 52) {
				break;
			}

			append += "<option value='" + i + "'>" + currentYear + "/" + i + "</option>";
		}
		$('#week').append(append);

		// Set the select element for the weeks to the correct week. 
		$('#week').val(currentWeek);

		// OnLoad
		if($.cookie('roosterClassNr')) {
		    refeshRooster($.cookie('roosterClassNr'), '2015', currentWeek);
		}

		$('#navicon-header').click(function() {
		    $('.sidebar').css('left', '0px');
		});

		$('#close-sidebar').click(function() {
		    $('.sidebar').css('left', '-360px');
		});

		$('#send-setting').click(function() {
		    var classNr = $('#classNr').val();
		    var week = $('#week').val();
		    $.cookie('roosterClassNr', classNr);
		    if($('.lesson').length != 0) {
			$('.lesson').fadeOut('400');
			setTimeout(function() {
			    $('.lesson').remove();
			    refeshRooster(classNr, '2015', week);
			}, 400);
		    }else{
			refeshRooster(classNr, '2015', week);
		    }
		});

		function refeshRooster(classNr, year, week) {
		    $.get('http://xedule.novaember.com/weekschedule.'+classNr+'.json?year='+year+'&week='+week, function(data){
			var data2 = $.parseJSON(data);
			var a = data2[0];
			var i = 0;
			for (k in data2) {
			    var v = data2[k];
			    var d = new Date(v.date);
			    
			    for (key in v.events) {
				var b = v.events[key];

				if (b == null) continue;

				// Calculate start time to float
				var startSplit = b.start.split(':');
				var startHour = parseFloat(startSplit[0]);
				var startMinute = parseFloat(startSplit[1]/60);
				var start = startHour+startMinute;

				// Calculate end time to float
				var endSplit = b.end.split(':');
				var endHour = parseFloat(endSplit[0]);
				var endMinute = parseFloat(endSplit[1]/60);
				var end = endHour+endMinute;

				var height = (end-start)*100;

				var color;
				var locatie;
				var staff = "";

				if(b.facilities.length == 0) 
				{ color = "#CCCCCC"; locatie=''; }else{ locatie = b.facilities[0]; color = getColor(b.facilities[0]); }

				if(b.staffs.length > 0) {
					staff = b.staffs[0];
				}

				if(b.facilities.length > 0 && b.staffs.length > 0) {
					locatie += " - ";
				}

				var out  = '<div style="border-left-color: '+color+'; height:'+(height-1)+'px; left:'+((k*167)+150)+'px; top:'+(51+(start-8.5)*100)+'px" class="lesson">';
				    out += '<span class="lesson-name">'+b.description+'</span><br>';
				    out += '<span>'+locatie+'</span><span class="teacher">'+staff+'</span>';
				    out += '</div>';

				$('.container').append(out);


				//console.log(b);

				//console.log(start-8.5);
			    }
			    $('table thead tr td:nth-child(' + (3+i) + ')').html(weekDays[d.getDay()] + " " + d.getDate() + " " + months[d.getMonth()]);
			    i++;
			}
			$('table thead tr td:nth-child(2)').html(year + "/" + week);
			$('.lesson').fadeIn('400');
		    });
		};

		function getColor(input)
		{
		    var sum = 0;

		    for(var i = 0; i < input.length; i++)
		    {
			sum += input.charCodeAt(i) * (i + 1);
		    }

		    var hue = (sum * Math.PI * 1000) % 360;

		    return "hsl(" + hue + ", 50%, 50%)";
		};
		
	</script>
</body>
</html>
